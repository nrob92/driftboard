/**
 * Check if a file path or filename is a DNG file
 */
export function isDNG(pathOrFilename: string): boolean {
  return pathOrFilename.toLowerCase().endsWith('.dng');
}

/**
 * Decode a DNG file buffer into a displayable image
 * Returns a data URL that can be used as an image source
 * Uses dynamic import to avoid SSR issues with libraw-wasm
 */
export async function decodeDNG(fileBuffer: ArrayBuffer): Promise<{
  dataUrl: string;
  width: number;
  height: number;
}> {
  // Dynamic import to avoid SSR issues - libraw-wasm uses browser APIs
  const LibRaw = (await import('libraw-wasm')).default;

  const raw = new LibRaw();

  await raw.open(new Uint8Array(fileBuffer), {
    useCameraWb: true,   // Use camera's recorded white balance
    outputColor: 1,       // sRGB color space
    outputBps: 8,         // 8-bit output
    userQual: 3,          // Good interpolation quality (0-12)
    halfSize: false,      // Full resolution
    noAutoBright: false,  // Allow auto brightness
  });

  // Get decoded RGB pixel data
  const imageData = await raw.imageData();

  // imageData is { data: Uint8Array (RGB), width, height }
  const { data, width, height } = imageData;

  // Convert RGB to RGBA for canvas
  const rgba = new Uint8ClampedArray(width * height * 4);
  for (let i = 0; i < width * height; i++) {
    rgba[i * 4] = data[i * 3];         // R
    rgba[i * 4 + 1] = data[i * 3 + 1]; // G
    rgba[i * 4 + 2] = data[i * 3 + 2]; // B
    rgba[i * 4 + 3] = 255;             // A (fully opaque)
  }

  // Convert to data URL for use with Konva Image
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d')!;
  ctx.putImageData(new ImageData(rgba, width, height), 0, 0);

  return {
    dataUrl: canvas.toDataURL('image/png'),
    width,
    height
  };
}

/**
 * Decode a DNG from a URL (e.g., Supabase storage URL)
 */
export async function decodeDNGFromUrl(url: string): Promise<{
  dataUrl: string;
  width: number;
  height: number;
}> {
  const response = await fetch(url);
  const buffer = await response.arrayBuffer();
  return decodeDNG(buffer);
}
